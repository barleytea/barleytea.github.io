{"componentChunkName":"component---src-templates-detail-tsx","path":"/go_producer_consumer/","result":{"data":{"markdownRemark":{"id":"914dddff-1e23-520f-8cf9-16946238d13f","html":"<div class=\"toc\">\n<ul>\n<li>\n<p><a href=\"#goroutine\">goroutine</a></p>\n<ul>\n<li><a href=\"#%E5%AE%9A%E7%BE%A9\">定義</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%90%8C%E6%9C%9F%E5%BE%85%E3%81%A1%E5%90%88%E3%82%8F%E3%81%9B\">同期（待ち合わせ）</a></p>\n<ul>\n<li><a href=\"#channel\">channel</a></li>\n<li><a href=\"#waitgroup\">WaitGroup</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#producer-consumer-pattern\">Producer-Consumer Pattern</a></p>\n</li>\n</ul>\n</div>\n<p>Go で並行処理のサンプル実装を作ったのでメモ\nソースコード全体は<a href=\"https://github.com/barleytea/go_sandbox/blob/main/producer_consumer/main.go\">ここ</a></p>\n<h2 id=\"goroutine\" style=\"position:relative;\"><a href=\"#goroutine\" aria-label=\"goroutine permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>goroutine</h2>\n<h3 id=\"定義\" style=\"position:relative;\"><a href=\"#%E5%AE%9A%E7%BE%A9\" aria-label=\"定義 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>定義</h3>\n<p>Go で並行処理を行うには <code class=\"language-text\">goroutine</code> という機能が必要になる。\n<a href=\"https://go.dev/ref/spec#Go_statements\">言語仕様書</a> では goroutine は下記のように定義されている。</p>\n<blockquote>\n<p>A \"go\" statement starts the execution of a function call as an independent concurrent thread of control, or goroutine, within the same address space.</p>\n</blockquote>\n<blockquote>\n<p>The expression must be a function or method call; it cannot be parenthesized. Calls of built-in functions are restricted as for expression statements.\nThe function value and parameters are evaluated as usual in the calling goroutine, but unlike with a regular call, program execution does not wait for the invoked function to complete. Instead, the function begins executing independently in a new goroutine. When the function terminates, its goroutine also terminates. If the function has any return values, they are discarded when the function completes.</p>\n</blockquote>\n<p>翻訳すると、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">go ステートメントは、同じアドレス空間内で、独立した並行スレッド（goroutine）として関数を実行する。\n\n関数の値とパラメータは呼び出し元の goroutine で通常通り評価される。通常の呼び出しとは異なり、プログラムの実行は呼び出された関数の完了を待たず、関数は新しい  goroutine で独立して実行される。関数が終了すると、その  goroutine も終了する。関数に戻り値がある場合、それらは関数が終了した時点で破棄される。</code></pre></div>\n<p>つまり goroutine は、通常の方法で実行される処理に対して並行に実行される関数のことだと理解すれば良さそうだ。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// goroutine を使わないバージョン</span>\n<span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"fmt\"</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> num<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"procuded %d\\n\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上記のコードは goroutine を使っておらず、当然下記のような出力となる。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">procuded 1\nprocuded 2\nprocuded 3\nprocuded 4\nprocuded 5\nprocuded 6\nprocuded 7\nprocuded 8\nprocuded 9\nprocuded 10</code></pre></div>\n<p>ここで、<code class=\"language-text\">produce</code> を goroutine 化してみる。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"fmt\"</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> num<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"procuded %d\\n\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">go</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// goroutine 化</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>しかし、これは実行しても何も出力されない。\n理由は、<code class=\"language-text\">go produce(10)</code> の実行が完了する前に <code class=\"language-text\">main</code> 処理が終了してしまったためである。</p>\n<p>これを防ぐためには <code class=\"language-text\">go say(\"hello\")</code> の終了を待ち合わせる（同期を取る）必要がある。\n待ち合わせを実現する方法として、<code class=\"language-text\">channel</code> を利用するパターンと、<code class=\"language-text\">sync.WaitGroup</code> を利用するパターンが考えられる。</p>\n<h2 id=\"同期待ち合わせ\" style=\"position:relative;\"><a href=\"#%E5%90%8C%E6%9C%9F%E5%BE%85%E3%81%A1%E5%90%88%E3%82%8F%E3%81%9B\" aria-label=\"同期待ち合わせ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>同期（待ち合わせ）</h2>\n<h3 id=\"channel\" style=\"position:relative;\"><a href=\"#channel\" aria-label=\"channel permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>channel</h3>\n<p><code class=\"language-text\">channel</code> とは、<a href=\"https://go.dev/ref/spec#Channel_types\">言語仕様</a> によれば、</p>\n<blockquote>\n<p>A channel provides a mechanism for concurrently executing functions to communicate by sending and receiving values of a specified element type.</p>\n</blockquote>\n<p>とあり、並行に実行される処理の間で値を受け渡しするための仕組みである。</p>\n<p>ここで、</p>\n<blockquote>\n<p>The capacity, in number of elements, sets the size of the buffer in the channel. If the capacity is zero or absent, the channel is unbuffered and communication succeeds only when both a sender and receiver are ready. Otherwise, the channel is buffered and communication succeeds without blocking if the buffer is not full (sends) or not empty (receives).</p>\n</blockquote>\n<p>とあるように、バッファなしの <code class=\"language-text\">channel</code> は送信操作と受信操作がペアで発生する必要があるため、この性質を利用して同期（待ち合わせ）を実現することができる。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"fmt\"</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> done <span class=\"token keyword\">chan</span><span class=\"token operator\">&lt;-</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> num<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"procuded %d\\n\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// channel にデータを送信する</span>\n\tdone <span class=\"token operator\">&lt;-</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// unbuffered channel を定義</span>\n\tdone<span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">go</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// channel からデータを受信する</span>\n\t<span class=\"token operator\">&lt;-</span>done\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">procuded 1\nprocuded 2\nprocuded 3\nprocuded 4\nprocuded 5\nprocuded 6\nprocuded 7\nprocuded 8\nprocuded 9\nprocuded 10</code></pre></div>\n<p><code class=\"language-text\">main</code> 関数の <code class=\"language-text\">&lt;-done</code> は <code class=\"language-text\">done</code> チャネルから値を受信するまでメインスレッドをブロックするので、<code class=\"language-text\">produce</code> ですべての処理を終えてから <code class=\"language-text\">done</code> チャネルに値を送信することで同期を取ることができる。</p>\n<h3 id=\"waitgroup\" style=\"position:relative;\"><a href=\"#waitgroup\" aria-label=\"waitgroup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WaitGroup</h3>\n<p>WaitGroup を使って同期を取ることもできる。</p>\n<p><a href=\"https://pkg.go.dev/sync#WaitGroup\">WaitGroup の言語仕様</a> によると、</p>\n<blockquote>\n<p>A WaitGroup waits for a collection of goroutines to finish. The main goroutine calls Add to set the number of goroutines to wait for. Then each of the goroutines runs and calls Done when finished. At the same time, Wait can be used to block until all goroutines have finished.</p>\n</blockquote>\n<blockquote>\n<p>A WaitGroup must not be copied after first use.</p>\n</blockquote>\n<blockquote>\n<p>In the terminology of the Go memory model, a call to Done “synchronizes before” the return of any Wait call that it unblocks.</p>\n</blockquote>\n<p>とある。</p>\n<p>下記のような手順で使用すれば良さそうだ。</p>\n<ol>\n<li><a href=\"https://pkg.go.dev/sync#WaitGroup.Add\">Add</a> を呼び出すことで待ち合わせる goroutine の数を WaitGroup 内部のカウンタに設定し、</li>\n<li>各 goroutine の終了時に <a href=\"https://pkg.go.dev/sync#WaitGroup.Done\">Done</a> を呼び出すことでカウンタをデクリメントし、</li>\n<li><a href=\"https://pkg.go.dev/sync#WaitGroup.Wait\">Wait</a> でカウンタが0になるまで（待ち合わせたい goroutine が全て終了するまで）メイン処理をブロックする</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"sync\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> wg <span class=\"token operator\">*</span>sync<span class=\"token punctuation\">.</span>WaitGroup<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// 2. goroutine の終了時に Done を呼び出すことでカウンタをデクリメントする</span>\n\t<span class=\"token keyword\">defer</span> wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> num<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"procuded %d\\n\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> wg sync<span class=\"token punctuation\">.</span>WaitGroup\n\t<span class=\"token comment\">// 1. Add を呼び出すことで待ち合わせる goroutine の数を WaitGroup 内部のカウンタに設定する</span>\n\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">go</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>wg<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// 3. Wait でカウンタが0になるまで（待ち合わせたい goroutine が全て終了するまで）メイン処理をブロックする</span>\n\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">procuded 1\nprocuded 2\nprocuded 3\nprocuded 4\nprocuded 5\nprocuded 6\nprocuded 7\nprocuded 8\nprocuded 9\nprocuded 10</code></pre></div>\n<p>ここで注意すべきことは、<code class=\"language-text\">go produce(\"10\", &amp;wg)</code> のように <code class=\"language-text\">WaitGroup</code> の参照を渡す必要があるということだ。\nというのも <a href=\"https://pkg.go.dev/sync#WaitGroup\">WaitGroup の言語仕様</a> に、</p>\n<blockquote>\n<p>A WaitGroup must not be copied after first use.</p>\n</blockquote>\n<p>とあるように、<code class=\"language-text\">WaitGroup</code> を複製するのはご法度だからである。</p>\n<p>ところで、<code class=\"language-text\">WaitGroup</code> は <code class=\"language-text\">Add</code> を持つことから推察されるように、複数の goroutine の同期を取る際にその威力を発揮する。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"sync\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> done <span class=\"token keyword\">chan</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> pg sync<span class=\"token punctuation\">.</span>WaitGroup\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> num<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n\t\ti <span class=\"token operator\">:=</span> i\n\t\tpg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 新たに goroutine 化</span>\n\t\t\t<span class=\"token keyword\">defer</span> pg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"procuded %d\\n\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tpg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\tdone <span class=\"token operator\">&lt;-</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tdone <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">go</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">)</span>\n\t<span class=\"token operator\">&lt;-</span>done\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">procuded 1\nprocuded 10\nprocuded 6\nprocuded 7\nprocuded 8\nprocuded 5\nprocuded 3\nprocuded 9\nprocuded 2\nprocuded 4</code></pre></div>\n<p>各数値ごとに print のための goroutine を立てるように変更した。\n<code class=\"language-text\">produce</code> 関数内で生成される10個の goroutine の同期を <code class=\"language-text\">WaitGroup</code> を利用して取っている。\nさらに、<code class=\"language-text\">produce</code> 関数自体も <code class=\"language-text\">go produce()</code> goroutine 化しているため、これが終了するまでメインスレッドをブロックするために <code class=\"language-text\">unbuffered channel</code> を使用している。</p>\n<p>各数値の print が並行に行われるため、出力順がばらばらになっていることが分かる。</p>\n<h2 id=\"producer-consumer-pattern\" style=\"position:relative;\"><a href=\"#producer-consumer-pattern\" aria-label=\"producer consumer pattern permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Producer-Consumer Pattern</h2>\n<p>Producer-Consumer Pattern は並行処理をデータの生産者と消費者に分離することで、スループットの向上等を狙うデザインパターンである。</p>\n<p>golang に限らず並行処理の文脈ではしばしば言及されるパターンだが、golang では <code class=\"language-text\">goroutine</code>, <code class=\"language-text\">WaitGroup</code>, <code class=\"language-text\">channel</code> を利用することで比較的容易に実装することができる。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"sync\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">var</span> wg sync<span class=\"token punctuation\">.</span>WaitGroup\n\tch <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// 1 ~ 10 までの整数を channel に送信する</span>\n\t<span class=\"token keyword\">go</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> ch<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// 3 個の consumer スレッド で channel からデータを受信する</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n\t\ti <span class=\"token operator\">:=</span> i\n\t\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">go</span> <span class=\"token function\">consume</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> ch<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>wg<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> ch <span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> pg sync<span class=\"token punctuation\">.</span>WaitGroup\n\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> num<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n\t\ti <span class=\"token operator\">:=</span> i\n\t\tpg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">defer</span> pg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\tch <span class=\"token operator\">&lt;-</span> i\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tpg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">consume</span><span class=\"token punctuation\">(</span>idx <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> ch <span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> wg <span class=\"token operator\">*</span>sync<span class=\"token punctuation\">.</span>WaitGroup<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">defer</span> wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> ch <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#%d: consumed %d\\n\"</span><span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#2: consumed 2\n#1: consumed 6\n#1: consumed 8\n#1: consumed 7\n#1: consumed 4\n#1: consumed 10\n#1: consumed 3\n#1: consumed 9\n#2: consumed 1\n#0: consumed 5</code></pre></div>\n<p><code class=\"language-text\">produce</code> 内では10個の goroutine を生成し、その値を3つの <code class=\"language-text\">consume</code> で受け取って print している。</p>\n<p>ちなみに <code class=\"language-text\">consume</code> で下記のように <code class=\"language-text\">range</code> を使っているのは、こうすることで <code class=\"language-text\">ch</code> が <code class=\"language-text\">close</code> されるまでループ処理を継続してくれるからだ。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> ch <span class=\"token punctuation\">{</span>\n\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#%d: consumed %d\\n\"</span><span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>そのため、<code class=\"language-text\">produce</code> 内では明示的に <code class=\"language-text\">ch</code> を <code class=\"language-text\">close</code> してやる必要がある。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">)</span></code></pre></div>","frontmatter":{"path":"/go_producer_consumer","title":"Go 並行処理超入門","created":"2023-12-29","tags":["Go","並行処理"],"eyecatcher":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAByklEQVR42uVTy0sCQRgfkIIe0H/QMaKDf0MU0SUK6tAp6had6hZEpyDy0KEOXaJDb3upPaCsk1QsFhmora6vfLS66KqltuY669jsjomRdelWwxy+/fb32Pl+s6D4iwX+HrmA5F25kNJEP5MxAqISRkKISEC5QMpbJCkFqJQkG9eEmMhJrJAnONLBtGdRgooY+upMQGw2P3QTrtMzqgNn12XQkxFxc8mTbDX6Ggwu9cXjIZuSncnHvcKCmReomHAXz/pfRbXRBzbt/dTTAMWCHXrKGp2yRcGare3MO2hmm3QMbpqiguwcyIjHodSyK6Gxx87Z9LRVxi26E6KEjp7SK97kgisBtHSHKZCTZC8Dm8bSExZOJguwgLcvLWr9z+6XXO9VCOzSWHHMEsEOtTpGtefAxTwTJ0ejeAFsP4zfc5/OTGYzbGbBhn3WwYeFvMbBgz1H84kHy7WbAniEXBZ2mgLY+SySAZUZQmUAVDzbeODE/Ho9A7bsLadeJpXrvgyCVWvNvlO1Q4N126Q1WiVnEqkl+TZqifRdh2boGPcGldjgnJPvuQ6N3IaNXKZ6VOW0Kh9RsYiqYb69YYXSFEo0jC7fFulDHvzD//kdBEVS+69hTmEAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/adb3f962ab537916915ee545c6640e28/ea462/eyecatcher.png","srcSet":"/static/adb3f962ab537916915ee545c6640e28/3e5dc/eyecatcher.png 59w,\n/static/adb3f962ab537916915ee545c6640e28/b0268/eyecatcher.png 118w,\n/static/adb3f962ab537916915ee545c6640e28/ea462/eyecatcher.png 235w","sizes":"(min-width: 235px) 235px, 100vw"},"sources":[{"srcSet":"/static/adb3f962ab537916915ee545c6640e28/1a17c/eyecatcher.webp 59w,\n/static/adb3f962ab537916915ee545c6640e28/2c82d/eyecatcher.webp 118w,\n/static/adb3f962ab537916915ee545c6640e28/88bdf/eyecatcher.webp 235w","type":"image/webp","sizes":"(min-width: 235px) 235px, 100vw"}]},"width":300,"height":300}}}}},"tags":{"nodes":[]}},"pageContext":{"id":"914dddff-1e23-520f-8cf9-16946238d13f","next":{"frontmatter":{"created":"2023-01-31","title":"iOS のヘルスケアアプリから Notion に体重を自動連携する","path":"/ios-healthcare-to-notion","tags":["Health","Notion"],"eyecatcher":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/f3d046a0be4e9d2e88d9d5d944a768b7/eaefa/barleytea.png","srcSet":"/static/f3d046a0be4e9d2e88d9d5d944a768b7/51b57/barleytea.png 30w,\n/static/f3d046a0be4e9d2e88d9d5d944a768b7/e63fa/barleytea.png 60w,\n/static/f3d046a0be4e9d2e88d9d5d944a768b7/eaefa/barleytea.png 120w,\n/static/f3d046a0be4e9d2e88d9d5d944a768b7/52057/barleytea.png 240w","sizes":"(min-width: 120px) 120px, 100vw"},"sources":[{"srcSet":"/static/f3d046a0be4e9d2e88d9d5d944a768b7/f1e6c/barleytea.webp 30w,\n/static/f3d046a0be4e9d2e88d9d5d944a768b7/eea8f/barleytea.webp 60w,\n/static/f3d046a0be4e9d2e88d9d5d944a768b7/43b57/barleytea.webp 120w,\n/static/f3d046a0be4e9d2e88d9d5d944a768b7/226ed/barleytea.webp 240w","type":"image/webp","sizes":"(min-width: 120px) 120px, 100vw"}]},"width":120,"height":90}}}}},"prev":null,"tags":["Go","並行処理"]}},"staticQueryHashes":["1725357224"],"slicesMap":{}}